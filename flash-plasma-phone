#!/bin/bash
set -ex

function download {
    mkdir -p ~/.cache/plasmaphone/ && cd ~/.cache/plasmaphone/
    # download cyanogenmod
    wget -c http://neon.plasma-mobile.org/cm-stripped.zip
    wget -c http://neon.plasma-mobile.org/twrp-3.0.2-0-hammerhead.img
    rm lxc-android.tar.gz
    wget -c https://jenkins.linuxcontainers.org/job/lxc-build-android/lastSuccessfulBuild/artifact/lxc-android.tar.gz
    wget -c http://mobile.neon.pangea.pub:8080/job/img_phone_xenial_armhf/lastSuccessfulBuild/artifact/result/livecd..rootfs.tar.gz
    wget -c https://raw.githubusercontent.com/plasma-phone-packaging/CM/master/lxc-system-config
    md5sum ~/.cache/plasmaphone/twrp-3.0.2-0-hammerhead.img
}

function flash-phone {
    echo "Waiting for device to be in the fastboot mode"
    fastboot getvar product

    echo "Flashing recovery"
    fastboot format cache
    fastboot flash recovery ~/.cache/plasmaphone/twrp-3.0.2-0-hammerhead.img
    fastboot boot ~/.cache/plasmaphone/twrp-3.0.2-0-hammerhead.img

    sleep 10
    echo "Flashing cyanogenmod now"
    adb push ~/.cache/plasmaphone/cm-stripped.zip /cache/cm.zip
    echo "--update_package=/cache/cm.zip" > /tmp/command
    adb push /tmp/command /cache/recovery/command

    adb reboot recovery
    adb wait-for-device

    echo "Done flashing cyanogenmod, now flashing rootfs and lxc"
}

function plasmafy {
    adb root
    sleep 5
    adb wait-for-device

    echo "Installing lxc userspace tools"
    adb push ~/.cache/plasmaphone/lxc-android.tar.gz /data/
    adb shell tar xf /data/lxc-android.tar.gz

    echo "Installing plasma rootfs"
    adb push ~/.cache/plasmaphone/livecd..rootfs.tar.gz /data/
    adb shell mkdir -p /data/lxc/containers/system/rootfs/
    adb shell tar xf /data/livecd..rootfs.tar.gz -C /data/lxc/containers/system/rootfs/
    adb shell rm /data/livecd..rootfs.tar.gz /data/lxc-android.tar.gz
    adb push ~/.cache/plasmaphone/lxc-system-config /data/lxc/containers/system/config

    echo "hacks"
    adb shell rm /data/lxc/containers/system/rootfs/etc/init/lxc-android-boot.conf
    adb shell mkdir -p /data/lxc/containers/system/rootfs/sys/fs/cgroup/
    adb push $PWD/hack /data/
    adb shell /data/hack

    adb reboot
    echo "Done flashing"
}

download
flash-phone
plasmafy
